<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Image Gallery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        body.dark {
            background-color: #0d1117;
            color: #c9d1d9;
        }
        body.light {
            background-color: #f5f6f5;
            color: #1a1c1e;
        }
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            padding: 1rem;
            flex-grow: 1;
        }
        @media (max-width: 640px) {
            .gallery-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }
        .gallery-item {
            overflow: hidden;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            transition: box-shadow 0.3s ease;
            user-select: none;
            -webkit-user-drag: none;
        }
        .gallery-item:hover {
            box-shadow: 0 0 10px rgba(88, 166, 255, 0.3);
        }
        .gallery-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            object-position: center;
            aspect-ratio: 1/1;
            opacity: 0;
            transition: opacity 0.3s ease-in;
            user-select: none;
            -webkit-user-drag: none;
        }
        @media (max-width: 640px) {
            .gallery-item img {
                height: 150px;
            }
        }
        .gallery-item img.loaded {
            opacity: 1;
        }
        .gallery-item .image-info {
            display: none;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 8px;
            background: rgba(0, 0, 0, 0.8);
            text-align: center;
            font-size: 0.9rem;
            color: #ffffff;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .gallery-item:hover .image-info {
            display: block;
            opacity: 1;
        }
        .viewer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            overflow: auto;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .viewer.active {
            opacity: 1;
        }
        .viewer img {
            max-width: 90%;
            max-height: 80%;
            object-fit: contain;
            image-rendering: pixelated; /* Non-smooth scaling */
            user-select: none;
            -webkit-user-drag: none;
        }
        .viewer .image-name {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 1rem;
        }
        .viewer .page-number {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 1rem;
        }
        .viewer .close-button,
        .viewer .arrow,
        .viewer .download-button,
        .viewer .download-pdf-button {
            position: absolute;
            background: rgba(0, 0, 0, 0.7);
            color: #ffffff;
            font-size: 1.2rem;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
        }
        .viewer .close-button:hover,
        .viewer .arrow:hover,
        .viewer .download-button:hover,
        .viewer .download-pdf-button:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }
        @media (max-width: 640px) {
            .viewer .close-button,
            .viewer .arrow,
            .viewer .download-button,
            .viewer .download-pdf-button {
                font-size: 1.5rem;
                padding: 10px;
            }
        }
        .viewer .controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
        }
        .viewer .arrow-left {
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
        }
        .viewer .arrow-right {
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }
        .header {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .header.dark {
            background: #161b22;
            border-bottom: 1px solid #30363d;
        }
        .header.light {
            background: #ffffff;
            border-bottom: 1px solid #d0d7de;
        }
        .header button, .header label {
            font-size: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
        }
        @media (max-width: 640px) {
            .header button, .header label {
                font-size: 1.2rem;
                padding: 0.75rem 1.25rem;
            }
        }
        .footer {
            text-align: center;
            padding: 1rem;
            font-size: 0.9rem;
            border-top: 1px solid;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .footer.dark {
            background: #161b22;
            border-top-color: #30363d;
            color: #c9d1d9;
        }
        .footer.light {
            background: #ffffff;
            border-top-color: #d0d7de;
            color: #1a1c1e;
        }
    </style>
</head>
<body class="antialiased dark">
    <div class="header dark">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-semibold">PDF Image Gallery</h1>
        </div>
        <div class="flex items-center gap-2">
            <button id="refreshButton" class="bg-gray-600 hover:bg-gray-700 text-white font-medium">Refresh</button>
            <label for="pdfInput" class="bg-blue-600 hover:bg-blue-700 text-white font-medium cursor-pointer flex items-center gap-2">
                <span class="text-lg">+</span> Add PDFs
            </label>
            <button id="themeToggle" class="bg-gray-600 hover:bg-gray-700 text-white font-medium">üåô</button>
            <input type="file" id="pdfInput" multiple accept=".pdf" class="hidden">
        </div>
    </div>

    <div class="container mx-auto p-4">
        <div id="gallery" class="gallery-grid"></div>
    </div>

    <div id="viewer" class="viewer">
        <div class="image-name" id="viewerImageName"></div>
        <div class="controls">
            <div class="close-button" onclick="hideViewer()">X</div>
            <div class="download-button" onclick="downloadImage()" title="Download PNG">üì•</div>
            <div class="download-pdf-button" onclick="downloadPDF()" title="Download PDF">üìú</div>
        </div>
        <div class="arrow arrow-left" onclick="prevImage()">‚ùÆ</div>
        <img id="viewerImage" src="">
        <div class="arrow arrow-right" onclick="nextImage()">‚ùØ</div>
        <div class="page-number" id="viewerPageNumber"></div>
    </div>

    <footer class="footer dark">
        PDF Image Gallery ¬© 2025
    </footer>

 <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    const pdfInput = document.getElementById('pdfInput');
    const refreshButton = document.getElementById('refreshButton');
    const themeToggle = document.getElementById('themeToggle');
    const gallery = document.getElementById('gallery');
    const viewer = document.getElementById('viewer');
    const viewerImage = document.getElementById('viewerImage');
    const viewerImageName = document.getElementById('viewerImageName');
    const viewerPageNumber = document.getElementById('viewerPageNumber');
    const header = document.querySelector('.header');
    const footer = document.querySelector('.footer');
    let images = [];
    let imageNames = [];
    let imageSizes = [];
    let imageFiles = [];
    let totalPages = 0;
    let currentImageIndex = 0;
    let zoomLevel = 1;

    // Load from localStorage with error handling
    function loadFromStorage() {
        try {
            const storedImages = localStorage.getItem('galleryImages');
            const storedNames = localStorage.getItem('galleryImageNames');
            const storedSizes = localStorage.getItem('galleryImageSizes');
            const storedTotalPages = localStorage.getItem('galleryTotalPages');

            if (storedImages) images = JSON.parse(storedImages) || [];
            if (storedNames) imageNames = JSON.parse(storedNames) || [];
            if (storedSizes) imageSizes = JSON.parse(storedSizes) || [];
            if (storedTotalPages) totalPages = parseInt(storedTotalPages) || 0;

            // Since File objects can't be stored, initialize imageFiles as empty or with pageNum
            imageFiles = images.map((_, index) => ({ file: null, pageNum: parseInt(imageNames[index].split(' - Page ')[1]) || 1 }));
        } catch (e) {
            console.error('Error loading from localStorage:', e);
            images = [];
            imageNames = [];
            imageSizes = [];
            imageFiles = [];
            totalPages = 0;
        }
    }

    // Save to localStorage with error handling
    function saveToStorage() {
        try {
            localStorage.setItem('galleryImages', JSON.stringify(images));
            localStorage.setItem('galleryImageNames', JSON.stringify(imageNames));
            localStorage.setItem('galleryImageSizes', JSON.stringify(imageSizes));
            localStorage.setItem('galleryTotalPages', totalPages);
        } catch (e) {
            console.error('Error saving to localStorage:', e);
            alert('Storage limit reached or error occurred. Some images may not be saved.');
        }
    }

    // Load stored images into gallery
    function loadStoredImages() {
        gallery.innerHTML = ''; // Clear gallery before repopulating
        images.forEach((imgData, index) => {
            addImageToGallery(imgData, imageNames[index], imageSizes[index], imageFiles[index].file, imageFiles[index].pageNum);
        });
    }

    // Initial load
    loadFromStorage();
    loadStoredImages();

    themeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark');
        document.body.classList.toggle('light');
        header.classList.toggle('dark');
        header.classList.toggle('light');
        footer.classList.toggle('dark');
        footer.classList.toggle('light');
        themeToggle.textContent = document.body.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
        themeToggle.classList.toggle('bg-gray-600');
        themeToggle.classList.toggle('bg-green-500');
        themeToggle.classList.toggle('hover:bg-gray-700');
        themeToggle.classList.toggle('hover:bg-green-600');
    });

    pdfInput.addEventListener('change', async (event) => {
        const files = Array.from(event.target.files).filter(file => file.name.endsWith('.pdf'));
        if (files.length === 0) return;

        for (let file of files) {
            await processPDF(file);
        }
        saveToStorage();
        loadStoredImages(); // Refresh gallery after adding new images
    });

    refreshButton.addEventListener('click', () => {
        gallery.innerHTML = '';
        images = [];
        imageNames = [];
        imageSizes = [];
        imageFiles = [];
        totalPages = 0;
        saveToStorage();
    });

    async function processPDF(file) {
        try {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            totalPages += pdf.numPages;

            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const page = await pdf.getPage(pageNum);
                const viewport = page.getViewport({ scale: 1.0 });

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                await page.render({
                    canvasContext: context,
                    viewport: viewport
                }).promise;

                const imgData = canvas.toDataURL('image/png', 0.8);
                addImageToGallery(imgData, `${file.name} - Page ${pageNum}`, file.size, file, pageNum);
            }
        } catch (e) {
            console.error(`Error processing ${file.name}:`, e);
            alert(`Error processing ${file.name}: ${e.message}`);
        }
    }

    function addImageToGallery(imgData, name, fileSize, file, pageNum) {
        const img = document.createElement('img');
        img.src = imgData;
        img.className = 'w-full h-48 object-cover';
        img.loading = 'lazy';
        img.onload = () => img.classList.add('loaded');
        img.setAttribute('draggable', 'false');

        const galleryItem = document.createElement('div');
        galleryItem.className = 'gallery-item';
        galleryItem.appendChild(img);

        const infoDiv = document.createElement('div');
        infoDiv.className = 'image-info';
        infoDiv.textContent = name;
        galleryItem.appendChild(infoDiv);

        gallery.appendChild(galleryItem);

        images.push(imgData);
        imageNames.push(name);
        imageSizes.push(fileSize);
        imageFiles.push({ file, pageNum });

        galleryItem.addEventListener('click', () => {
            currentImageIndex = images.indexOf(imgData);
            zoomLevel = 1;
            showViewer();
        });

        galleryItem.addEventListener('contextmenu', (e) => e.preventDefault());
    }

    function showViewer() {
        viewerImage.src = images[currentImageIndex];
        viewerImageName.textContent = imageNames[currentImageIndex].split(' - ')[0];
        viewerPageNumber.textContent = `Page ${imageNames[currentImageIndex].split(' - Page ')[1]} / ${totalPages}`;
        viewer.style.display = 'flex';
        viewerImage.setAttribute('draggable', 'false');
        viewerImage.style.transform = 'none';
        setTimeout(() => viewer.classList.add('active'), 10);
    }

    function hideViewer() {
        viewer.classList.remove('active');
        setTimeout(() => {
            viewer.style.display = 'none';
            zoomLevel = 1;
        }, 300);
    }

    function prevImage() {
        currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
        zoomLevel = 1;
        showViewer();
    }

    function nextImage() {
        currentImageIndex = (currentImageIndex + 1) % images.length;
        zoomLevel = 1;
        showViewer();
    }

    async function downloadImage() {
        const imgData = images[currentImageIndex];
        const canvas = document.createElement('canvas');
        const img = new Image();
        img.src = imgData;
        await new Promise(resolve => img.onload = resolve);

        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);

        ctx.font = '40px Arial';
        ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
        ctx.textAlign = 'right';
        ctx.textBaseline = 'bottom';
        ctx.fillText('PIG', canvas.width - 10, canvas.height - 10);

        const link = document.createElement('a');
        link.href = canvas.toDataURL('image/png', 1.0);
        link.download = `${imageNames[currentImageIndex].replace(' - Page ', '_page_')}.png`;
        link.click();
    }

    function downloadPDF() {
        const { file } = imageFiles[currentImageIndex];
        if (!file) {
            alert('Original PDF not available for download. Please re-upload the PDF.');
            return;
        }
        const link = document.createElement('a');
        link.href = URL.createObjectURL(file);
        link.download = file.name;
        link.click();
        URL.revokeObjectURL(link.href);
    }

    viewer.addEventListener('click', (event) => {
        if (event.target === viewer) {
            hideViewer();
        }
    });

    viewer.addEventListener('contextmenu', (e) => e.preventDefault());

    viewer.addEventListener('wheel', (event) => {
        event.preventDefault();
        const delta = event.deltaY > 0 ? -0.1 : 0.1;
        zoomLevel = Math.max(0.5, Math.min(zoomLevel + delta, 3));
        viewerImage.style.transform = `scale(${zoomLevel})`;
    });

    let initialDistance = null;
    let touchStartX = 0;
    viewer.addEventListener('touchstart', (event) => {
        if (event.touches.length === 2) {
            initialDistance = Math.hypot(
                event.touches[0].pageX - event.touches[1].pageX,
                event.touches[0].pageY - event.touches[1].pageY
            );
        } else {
            touchStartX = event.changedTouches[0].screenX;
        }
    });

    viewer.addEventListener('touchmove', (event) => {
        if (event.touches.length === 2) {
            event.preventDefault();
            const currentDistance = Math.hypot(
                event.touches[0].pageX - event.touches[1].pageX,
                event.touches[0].pageY - event.touches[1].pageY
            );
            if (initialDistance) {
                const scaleChange = currentDistance / initialDistance;
                zoomLevel = Math.max(0.5, Math.min(zoomLevel * scaleChange, 3));
                viewerImage.style.transform = `scale(${zoomLevel})`;
                initialDistance = currentDistance;
            }
        }
    });

    viewer.addEventListener('touchend', (event) => {
        if (event.touches.length < 2) {
            initialDistance = null;
        }
        if (event.changedTouches.length === 1 && !initialDistance) {
            const touchEndX = event.changedTouches[0].screenX;
            const deltaX = touchEndX - touchStartX;
            if (Math.abs(deltaX) > 50) {
                if (deltaX > 0) prevImage();
                else nextImage();
            }
        }
    });

    document.addEventListener('keydown', (event) => {
        if (viewer.style.display === 'flex') {
            if (event.key === 'ArrowLeft') prevImage();
            if (event.key === 'ArrowRight') nextImage();
            if (event.key === 'Escape') hideViewer();
            if (event.ctrlKey && (event.key === 's' || event.key === 'S')) {
                event.preventDefault();
            }
        }
    });
</script>
</body>
</html>
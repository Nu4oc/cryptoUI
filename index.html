<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Image Gallery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
        }
        body.dark {
            background-color: #0d1117;
            color: #c9d1d9;
        }
        body.light {
            background-color: #f5f6f5;
            color: #1a1c1e;
        }
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.75rem;
            padding: 0.75rem;
            flex-grow: 1;
        }
        @media (max-width: 640px) {
            .gallery-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 0.5rem;
                padding: 0.5rem;
            }
        }
        .gallery-item {
            overflow: hidden;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            transition: box-shadow 0.3s ease;
            user-select: none;
            -webkit-user-drag: none;
        }
        .gallery-item:hover {
            box-shadow: 0 0 10px rgba(88, 166, 255, 0.3);
        }
        .gallery-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            object-position: center;
            aspect-ratio: 1/1;
            opacity: 0;
            transition: opacity 0.3s ease-in;
            user-select: none;
            -webkit-user-drag: none;
        }
        @media (max-width: 640px) {
            .gallery-item img {
                height: 100px;
            }
        }
        .gallery-item img.loaded {
            opacity: 1;
        }
        .gallery-item .image-info {
            display: none;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 6px;
            background: rgba(0, 0, 0, 0.8);
            text-align: center;
            font-size: 0.75rem;
            color: #ffffff;
            opacity: 0;
            transition: opacity 0.3s ease;
            word-break: break-all;
        }
        .gallery-item:hover .image-info {
            display: block;
            opacity: 1;
        }
        .viewer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            overflow: auto;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .viewer.active {
            opacity: 1;
        }
        .viewer img {
            max-width: 90%;
            max-height: 80%;
            object-fit: contain;
            image-rendering: pixelated;
            user-select: none;
            -webkit-user-drag: none;
            touch-action: pinch-zoom;
        }
        .viewer .image-name {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            max-width: 80%;
            text-align: center;
            word-break: break-all;
        }
        .viewer .page-number {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        .viewer .close-button,
        .viewer .arrow,
        .viewer .download-button,
        .viewer .download-pdf-button {
            position: absolute;
            background: rgba(0, 0, 0, 0.7);
            color: #ffffff;
            font-size: 1.2rem;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
        }
        @media (max-width: 640px) {
            .viewer .close-button,
            .viewer .arrow,
            .viewer .download-button,
            .viewer .download-pdf-button {
                font-size: 1.5rem;
                padding: 12px;
            }
        }
        .viewer .close-button:hover,
        .viewer .arrow:hover,
        .viewer .download-button:hover,
        .viewer .download-pdf-button:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }
        .viewer .controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
        }
        .viewer .arrow-left {
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
        }
        .viewer .arrow-right {
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }
        .header {
            padding: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .header.dark {
            background: #161b22;
            border-bottom: 1px solid #30363d;
        }
        .header.light {
            background: #ffffff;
            border-bottom: 1px solid #d0d7de;
        }
        .header button, .header label {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
        }
        @media (max-width: 640px) {
            .header button, .header label {
                font-size: 1rem;
                padding: 0.6rem 1.2rem;
            }
            .header h1 {
                font-size: 1rem;
            }
        }
        .footer {
            text-align: center;
            padding: 0.75rem;
            font-size: 0.8rem;
            border-top: 1px solid;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .footer.dark {
            background: #161b22;
            border-top-color: #30363d;
            color: #c9d1d9;
        }
        .footer.light {
            background: #ffffff;
            border-top-color: #d0d7de;
            color: #1a1c1e;
        }
    </style>
</head>
<body class="antialiased dark">
    <div class="header dark">
        <div class="flex items-center gap-4">
            <h1 class="text-lg font-semibold">PDF Image Gallery</h1>
        </div>
        <div class="flex items-center gap-2">
            <button id="refreshButton" class="bg-gray-600 hover:bg-gray-700 text-white font-medium">Refresh</button>
            <label for="pdfInput" class="bg-blue-600 hover:bg-blue-700 text-white font-medium cursor-pointer flex items-center gap-2">
                <span class="text-lg">+</span> Add PDFs
            </label>
            <button id="themeToggle" class="bg-gray-600 hover:bg-gray-700 text-white font-medium">üåô</button>
            <input type="file" id="pdfInput" multiple accept=".pdf" class="hidden">
        </div>
    </div>

    <div class="container mx-auto p-4">
        <div id="gallery" class="gallery-grid"></div>
    </div>

    <div id="viewer" class="viewer">
        <div class="image-name" id="viewerImageName"></div>
        <div class="controls">
            <div class="close-button" onclick="hideViewer()">X</div>
            <div class="download-button" onclick="downloadImage()" title="Download PNG">üì•</div>
            <div class="download-pdf-button" onclick="downloadPDF()" title="Download PDF">üìú</div>
        </div>
        <div class="arrow arrow-left" onclick="prevImage()">‚ùÆ</div>
        <img id="viewerImage" src="">
        <div class="arrow arrow-right" onclick="nextImage()">‚ùØ</div>
        <div class="page-number" id="viewerPageNumber"></div>
    </div>

    <footer class="footer dark">
        PDF Image Gallery ¬© 2025
    </footer>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        const pdfInput = document.getElementById('pdfInput');
        const refreshButton = document.getElementById('refreshButton');
        const themeToggle = document.getElementById('themeToggle');
        const gallery = document.getElementById('gallery');
        const viewer = document.getElementById('viewer');
        const viewerImage = document.getElementById('viewerImage');
        const viewerImageName = document.getElementById('viewerImageName');
        const viewerPageNumber = document.getElementById('viewerPageNumber');
        const header = document.querySelector('.header');
        const footer = document.querySelector('.footer');
        let images = [];
        let imageNames = [];
        let imageSizes = [];
        let imagePDFs = [];
        let totalPages = 0;
        let currentImageIndex = 0;
        let zoomLevel = 1;

        // Kh·ªüi t·∫°o IndexedDB
        const dbName = 'PDFGalleryDB';
        const storeName = 'gallery';
        let db;

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, 1);
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    db.createObjectStore(storeName, { keyPath: 'id', autoIncrement: true });
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                request.onerror = (event) => {
                    console.error('Error opening IndexedDB:', event);
                    alert('Failed to initialize storage. Please try again.');
                    reject(event);
                };
            });
        }

        // L∆∞u d·ªØ li·ªáu v√†o IndexedDB
        async function saveToDB() {
            try {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                store.clear(); // X√≥a d·ªØ li·ªáu c≈© tr∆∞·ªõc khi l∆∞u m·ªõi
                images.forEach((imgData, index) => {
                    store.add({
                        image: imgData,
                        name: imageNames[index],
                        size: imageSizes[index],
                        pdfData: imagePDFs[index].pdfData,
                        pageNum: imagePDFs[index].pageNum
                    });
                });
                await new Promise((resolve, reject) => {
                    transaction.oncomplete = resolve;
                    transaction.onerror = () => reject('Error saving to IndexedDB');
                });
                localStorage.setItem('galleryTotalPages', totalPages); // L∆∞u totalPages v√†o localStorage
            } catch (e) {
                console.error('Error saving to IndexedDB:', e);
                alert('Failed to save data. Storage may be full or unavailable.');
            }
        }

        // T·∫£i d·ªØ li·ªáu t·ª´ IndexedDB
        async function loadFromDB() {
            try {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                await new Promise((resolve, reject) => {
                    request.onsuccess = () => {
                        const data = request.result;
                        images = data.map(item => item.image);
                        imageNames = data.map(item => item.name);
                        imageSizes = data.map(item => item.size);
                        imagePDFs = data.map(item => ({ pdfData: item.pdfData, pageNum: item.pageNum }));
                        totalPages = parseInt(localStorage.getItem('galleryTotalPages')) || 0;
                        resolve();
                    };
                    request.onerror = () => reject('Error loading from IndexedDB');
                });
            } catch (e) {
                console.error('Error loading from IndexedDB:', e);
                images = [];
                imageNames = [];
                imageSizes = [];
                imagePDFs = [];
                totalPages = 0;
            }
        }

        // T·∫£i h√¨nh ·∫£nh v√†o gallery
        async function loadStoredImages() {
            gallery.innerHTML = '';
            images.forEach((imgData, index) => {
                addImageToGallery(imgData, imageNames[index], imageSizes[index], imagePDFs[index].pageNum);
            });
        }

        // Kh·ªüi t·∫°o
        async function init() {
            await openDB();
            await loadFromDB();
            await loadStoredImages();
        }
        init();

        // Chuy·ªÉn ƒë·ªïi giao di·ªán s√°ng/t·ªëi
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark');
            document.body.classList.toggle('light');
            header.classList.toggle('dark');
            header.classList.toggle('light');
            footer.classList.toggle('dark');
            footer.classList.toggle('light');
            themeToggle.textContent = document.body.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
            themeToggle.classList.toggle('bg-gray-600');
            themeToggle.classList.toggle('bg-green-500');
            themeToggle.classList.toggle('hover:bg-gray-700');
            themeToggle.classList.toggle('hover:bg-green-600');
        });

        // X·ª≠ l√Ω t·∫£i PDF
        pdfInput.addEventListener('change', async (event) => {
            const files = Array.from(event.target.files).filter(file => file.name.endsWith('.pdf'));
            if (files.length === 0) return;

            for (let file of files) {
                await processPDF(file);
            }
            await saveToDB();
            await loadStoredImages();
        });

        // X√≥a to√†n b·ªô d·ªØ li·ªáu
        refreshButton.addEventListener('click', async () => {
            gallery.innerHTML = '';
            images = [];
            imageNames = [];
            imageSizes = [];
            imagePDFs = [];
            totalPages = 0;
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            store.clear();
            localStorage.removeItem('galleryTotalPages');
            await new Promise(resolve => transaction.oncomplete = resolve);
        });

        // X·ª≠ l√Ω PDF v√† chuy·ªÉn th√†nh h√¨nh ·∫£nh
        async function processPDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdfDataUrl = arrayBufferToDataUrl(arrayBuffer);
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                totalPages += pdf.numPages;

                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    const viewport = page.getViewport({ scale: 1.0 });

                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;

                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;

                    const imgData = canvas.toDataURL('image/png', 0.7);
                    addImageToGallery(imgData, `${file.name} - Page ${pageNum}`, file.size, pageNum);
                    imagePDFs.push({ pdfData: pdfDataUrl, pageNum });
                }
            } catch (e) {
                console.error(`Error processing ${file.name}:`, e);
                alert(`Error processing ${file.name}: ${e.message}`);
            }
        }

        // Chuy·ªÉn arrayBuffer th√†nh dataURL
        function arrayBufferToDataUrl(arrayBuffer) {
            const blob = new Blob([arrayBuffer], { type: 'application/pdf' });
            return URL.createObjectURL(blob);
        }

        // Th√™m h√¨nh ·∫£nh v√†o gallery
        function addImageToGallery(imgData, name, fileSize, pageNum) {
            const img = document.createElement('img');
            img.src = imgData;
            img.className = 'w-full h-24 object-cover sm:h-36';
            img.loading = 'lazy';
            img.onload = () => img.classList.add('loaded');
            img.setAttribute('draggable', 'false');

            const galleryItem = document.createElement('div');
            galleryItem.className = 'gallery-item';
            galleryItem.appendChild(img);

            const infoDiv = document.createElement('div');
            infoDiv.className = 'image-info';
            infoDiv.textContent = name;
            galleryItem.appendChild(infoDiv);

            gallery.appendChild(galleryItem);

            images.push(imgData);
            imageNames.push(name);
            imageSizes.push(fileSize);

            galleryItem.addEventListener('click', () => {
                currentImageIndex = images.indexOf(imgData);
                zoomLevel = 1;
                showViewer();
            });

            galleryItem.addEventListener('contextmenu', (e) => e.preventDefault());
        }

        // Hi·ªÉn th·ªã viewer
        function showViewer() {
            viewerImage.src = images[currentImageIndex];
            viewerImageName.textContent = imageNames[currentImageIndex].split(' - ')[0];
            viewerPageNumber.textContent = `Page ${imageNames[currentImageIndex].split(' - Page ')[1]} / ${totalPages}`;
            viewer.style.display = 'flex';
            viewerImage.setAttribute('draggable', 'false');
            viewerImage.style.transform = 'none';
            setTimeout(() => viewer.classList.add('active'), 10);
        }

        // ·∫®n viewer
        function hideViewer() {
            viewer.classList.remove('active');
            setTimeout(() => {
                viewer.style.display = 'none';
                zoomLevel = 1;
            }, 300);
        }

        // Chuy·ªÉn ƒë·∫øn ·∫£nh tr∆∞·ªõc
        function prevImage() {
            currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
            zoomLevel = 1;
            showViewer();
        }

        // Chuy·ªÉn ƒë·∫øn ·∫£nh sau
        function nextImage() {
            currentImageIndex = (currentImageIndex + 1) % images.length;
            zoomLevel = 1;
            showViewer();
        }

        // T·∫£i ·∫£nh PNG
        async function downloadImage() {
            const imgData = images[currentImageIndex];
            const canvas = document.createElement('canvas');
            const img = new Image();
            img.src = imgData;
            await new Promise(resolve => img.onload = resolve);

            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);

            ctx.font = '30px Arial';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'bottom';
            ctx.fillText('PIG', canvas.width - 10, canvas.height - 10);

            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png', 1.0);
            link.download = `${imageNames[currentImageIndex].replace(' - Page ', '_page_')}.png`;
            link.click();
        }

        // T·∫£i PDF g·ªëc
        function downloadPDF() {
            const { pdfData } = imagePDFs[currentImageIndex];
            if (!pdfData) {
                alert('Original PDF not available. Please re-upload the PDF.');
                return;
            }
            const link = document.createElement('a');
            link.href = pdfData;
            link.download = imageNames[currentImageIndex].split(' - ')[0];
            link.click();
        }

        // S·ª± ki·ªán click n·ªÅn viewer ƒë·ªÉ ƒë√≥ng
        viewer.addEventListener('click', (event) => {
            if (event.target === viewer) {
                hideViewer();
            }
        });

        viewer.addEventListener('contextmenu', (e) => e.preventDefault());

        // Ph√≥ng to/thu nh·ªè b·∫±ng b√°nh xe chu·ªôt
        viewer.addEventListener('wheel', (event) => {
            event.preventDefault();
            const delta = event.deltaY > 0 ? -0.1 : 0.1;
            zoomLevel = Math.max(0.5, Math.min(zoomLevel + delta, 3));
            viewerImage.style.transform = `scale(${zoomLevel})`;
        });

        // H·ªó tr·ª£ c·∫£m ·ª©ng (pinch-to-zoom v√† vu·ªët)
        let initialDistance = null;
        let touchStartX = 0;
        viewer.addEventListener('touchstart', (event) => {
            if (event.touches.length === 2) {
                initialDistance = Math.hypot(
                    event.touches[0].pageX - event.touches[1].pageX,
                    event.touches[0].pageY - event.touches[1].pageY
                );
            } else {
                touchStartX = event.changedTouches[0].screenX;
            }
        });

        viewer.addEventListener('touchmove', (event) => {
            if (event.touches.length === 2) {
                event.preventDefault();
                const currentDistance = Math.hypot(
                    event.touches[0].pageX - event.touches[1].pageX,
                    event.touches[0].pageY - event.touches[1].pageY
                );
                if (initialDistance) {
                    const scaleChange = currentDistance / initialDistance;
                    zoomLevel = Math.max(0.5, Math.min(zoomLevel * scaleChange, 3));
                    viewerImage.style.transform = `scale(${zoomLevel})`;
                    initialDistance = currentDistance;
                }
            }
        });

        viewer.addEventListener('touchend', (event) => {
            if (event.touches.length < 2) {
                initialDistance = null;
            }
            if (event.changedTouches.length === 1 && !initialDistance) {
                const touchEndX = event.changedTouches[0].screenX;
                const deltaX = touchEndX - touchStartX;
                if (Math.abs(deltaX) > 50) {
                    if (deltaX > 0) prevImage();
                    else nextImage();
                }
            }
        });

        // ƒêi·ªÅu khi·ªÉn b·∫±ng b√†n ph√≠m
        document.addEventListener('keydown', (event) => {
            if (viewer.style.display === 'flex') {
                if (event.key === 'ArrowLeft') prevImage();
                if (event.key === 'ArrowRight') nextImage();
                if (event.key === 'Escape') hideViewer();
                if (event.ctrlKey && (event.key === 's' || event.key === 'S')) {
                    event.preventDefault();
                    downloadImage();
                }
            }
        });
    </script>
</body>
</html>
